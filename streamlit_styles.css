"""
NotebookLM Manuscript AI Studio - Streamlit App Example
Full working app with styling, state management, and interactions
"""

import streamlit as st
from datetime import datetime, timedelta
import os

# Page config
st.set_page_config(
    page_title="Manuscript AI Studio",
    page_icon="üìö",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# Load CSS
css_path = os.path.join(os.path.dirname(__file__), 'streamlit_styles.css')
with open(css_path) as f:
    st.markdown(f'<style>{f.read()}</style>', unsafe_allow_html=True)

# Initialize session state
if "sources" not in st.session_state:
    st.session_state.sources = [
        {"name": "research_paper.pdf", "size": "2.4 MB", "date": "Added 2 hours ago", "id": 1},
        {"name": "notes.txt", "size": "1.2 KB", "date": "Added 1 day ago", "id": 2}
    ]

if "chat_history" not in st.session_state:
    st.session_state.chat_history = [
        {"role": "assistant", "content": "This document covers machine learning fundamentals. You can ask questions about it below!"},
        {"role": "user", "content": "What are the key concepts in chapter 3?"},
        {"role": "assistant", "content": "Chapter 3 covers supervised learning methods including linear regression, logistic regression, and decision trees. Key concepts include: 1) Model fitting, 2) Loss functions, 3) Gradient descent, and 4) Regularization techniques."}
    ]

if "credits" not in st.session_state:
    st.session_state.credits = 150

if "studio_output" not in st.session_state:
    st.session_state.studio_output = None

if "studio_loading" not in st.session_state:
    st.session_state.studio_loading = False

# ============================================================================
# TOP BAR
# ============================================================================
st.markdown(f'''
<div class="ms-topbar">
  <h1 class="ms-topbar-title">üìö Manuscript AI</h1>
  <div class="ms-topbar-credits">
    Credits: <span class="ms-credits-value">{st.session_state.credits}</span>
  </div>
</div>
''', unsafe_allow_html=True)

# ============================================================================
# MAIN 2-COLUMN LAYOUT (Sources + Chat)
# ============================================================================
st.markdown('<div class="ms-container">', unsafe_allow_html=True)

# LEFT COLUMN: SOURCES CARD
with st.container():
    st.markdown('''
    <div class="ms-card">
      <h2 class="ms-card-title">
        <span class="ms-card-icon">üìÑ</span> Sources
      </h2>
    ''', unsafe_allow_html=True)
    
    # Sources list or empty state
    if st.session_state.sources:
        st.markdown('<div class="ms-sources-list">', unsafe_allow_html=True)
        
        for source in st.session_state.sources:
            col1, col2 = st.columns([0.85, 0.15])
            
            with col1:
                st.markdown(f'''
                <div class="ms-source-item" style="margin: 8px 0;">
                  <div class="ms-source-info">
                    <div class="ms-source-name">{source['name']}</div>
                    <div class="ms-source-meta">{source['size']} ‚Ä¢ {source['date']}</div>
                  </div>
                </div>
                ''', unsafe_allow_html=True)
            
            with col2:
                if st.button("‚úï", key=f"delete_{source['id']}", help="Delete source"):
                    st.session_state.sources.remove(source)
                    st.rerun()
        
        st.markdown('</div>', unsafe_allow_html=True)
    else:
        st.markdown('''
        <div class="ms-empty-state">
          <div class="ms-empty-icon">üì≠</div>
          <div class="ms-empty-text">No sources yet.<br/>Add a PDF or paste text.</div>
        </div>
        ''', unsafe_allow_html=True)
    
    # Action buttons
    st.markdown('<div class="ms-button-group">', unsafe_allow_html=True)
    
    if st.button("+ Upload PDF", use_container_width=True, key="upload_pdf"):
        st.session_state.sources.append({
            "name": "new_document.pdf",
            "size": "3.1 MB",
            "date": f"Added {datetime.now().strftime('%H:%M')}",
            "id": max([s['id'] for s in st.session_state.sources]) + 1
        })
        st.session_state.credits -= 1
        st.rerun()
    
    st.markdown('<span class="ms-button-helper">1 credit per upload</span>', unsafe_allow_html=True)
    
    if st.button("‚úèÔ∏è Paste Text", use_container_width=True, key="paste_text"):
        st.session_state.sources.append({
            "name": "pasted_text.txt",
            "size": "2.5 KB",
            "date": f"Added {datetime.now().strftime('%H:%M')}",
            "id": max([s['id'] for s in st.session_state.sources]) + 1 if st.session_state.sources else 1
        })
        st.session_state.credits -= 1
        st.rerun()
    
    st.markdown('<span class="ms-button-helper">1 credit per upload</span>', unsafe_allow_html=True)
    st.markdown('</div>', unsafe_allow_html=True)
    
    st.markdown('</div>', unsafe_allow_html=True)

# RIGHT COLUMN: CHAT CARD
with st.container():
    st.markdown('''
    <div class="ms-card">
      <h2 class="ms-card-title">
        <span class="ms-card-icon">üí¨</span> Chat
      </h2>
    ''', unsafe_allow_html=True)
    
    # Messages container
    if st.session_state.chat_history:
        st.markdown('<div class="ms-chat-messages">', unsafe_allow_html=True)
        
        for msg in st.session_state.chat_history:
            user_class = 'user' if msg['role'] == 'user' else ''
            st.markdown(f'<div class="ms-message {user_class}">{msg["content"]}</div>', unsafe_allow_html=True)
        
        st.markdown('</div>', unsafe_allow_html=True)
    else:
        st.markdown('''
        <div class="ms-empty-state">
          <div class="ms-empty-icon">üí≠</div>
          <div class="ms-empty-text">Start a conversation<br/>to analyze your sources.</div>
        </div>
        ''', unsafe_allow_html=True)
    
    # Chat input
    user_input = st.text_area(
        "Ask about your sources...",
        placeholder="Ask about your sources...",
        height=80,
        label_visibility="collapsed",
        key="chat_input"
    )
    
    # Send button and helper
    col1, col2 = st.columns([0.85, 0.15])
    with col1:
        st.markdown('<span class="ms-input-helper">1 credit per message</span>', unsafe_allow_html=True)
    with col2:
        if st.button("‚Üí", key="send_message"):
            if user_input.strip():
                st.session_state.chat_history.append({"role": "user", "content": user_input})
                st.session_state.chat_history.append({
                    "role": "assistant",
                    "content": "This is an AI-generated response based on your sources. Replace with actual LLM integration."
                })
                st.session_state.credits -= 1
                st.rerun()
    
    # Suggestions
    st.markdown('''
    <div class="ms-suggestions">
      <button class="ms-chip">Summarize key points</button>
      <button class="ms-chip">What's the main idea?</button>
      <button class="ms-chip">Define technical terms</button>
    </div>
    ''', unsafe_allow_html=True)
    
    st.markdown('</div>', unsafe_allow_html=True)

st.markdown('</div>', unsafe_allow_html=True)  # Close ms-container

# ============================================================================
# STUDIO SECTION (Full Width)
# ============================================================================
st.markdown('''
<div class="ms-card">
  <h2 class="ms-card-title">
    <span class="ms-card-icon">‚ú®</span> Studio
  </h2>
  <div class="ms-studio-grid">
''', unsafe_allow_html=True)

# Studio action cards
col1, col2, col3 = st.columns(3)

with col1:
    if st.button("üìã\nGenerate Summary", key="summary", use_container_width=True):
        st.session_state.studio_output = {
            "type": "Summary",
            "icon": "üìã",
            "content": """This document provides a comprehensive introduction to machine learning, covering fundamental concepts such as supervised and unsupervised learning, feature engineering, model evaluation, and practical implementation strategies.

The key takeaways include understanding the importance of data quality, selecting appropriate algorithms based on your problem type, and iteratively refining your models through cross-validation and hyperparameter tuning."""
        }
        st.session_state.credits -= 3
        st.rerun()

with col2:
    if st.button("‚ùì\nCreate Flashcards", key="flashcards", use_container_width=True):
        st.session_state.studio_output = {
            "type": "Flashcards",
            "icon": "‚ùì",
            "content": """Q: What is supervised learning?
A: Learning from labeled examples where the input is paired with correct output.

Q: Name three common ML algorithms.
A: Linear Regression, Logistic Regression, Decision Trees.

Q: What is overfitting?
A: When a model learns noise in training data and performs poorly on new data."""
        }
        st.session_state.credits -= 3
        st.rerun()

with col3:
    if st.button("üéØ\nMake Quiz", key="quiz", use_container_width=True):
        st.session_state.studio_output = {
            "type": "Quiz",
            "icon": "üéØ",
            "content": """1. What is the primary goal of feature engineering?
   a) Reduce data size
   b) Create meaningful features that improve model performance ‚úì
   c) Increase training time
   d) Remove all outliers

2. Which metric is best for imbalanced classification?
   a) Accuracy
   b) F1-Score ‚úì
   c) Mean Absolute Error
   d) R-squared"""
        }
        st.session_state.credits -= 3
        st.rerun()

st.markdown('</div>', unsafe_allow_html=True)

# Output container
if st.session_state.studio_output:
    output = st.session_state.studio_output
    st.markdown(f'''
    <div class="ms-output-container">
      <div class="ms-output-title">
        {output['icon']} {output['type']}
      </div>
      <div class="ms-output-content">
        {output['content'].replace(chr(10), '<br/>')}
      </div>
    </div>
    ''', unsafe_allow_html=True)
else:
    st.markdown('''
    <div class="ms-empty-state">
      <div class="ms-empty-icon">üé¨</div>
      <div class="ms-empty-text">Select an action above<br/>to generate content.</div>
    </div>
    ''', unsafe_allow_html=True)

st.markdown('</div>', unsafe_allow_html=True)  # Close ms-card
